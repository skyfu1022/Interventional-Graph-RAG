"""
LangGraph å·¥ä½œæµå¯è§†åŒ–å·¥å…·æ¨¡å—ã€‚

è¯¥æ¨¡å—æä¾›äº†ç”¨äºå¯è§†åŒ–å’Œå¯¼å‡º LangGraph å·¥ä½œæµçš„å®ç”¨å·¥å…·å‡½æ•°ã€‚
æ”¯æŒ Mermaid æ ¼å¼ã€ASCII è‰ºæœ¯å’Œ JSON æ ¼å¼çš„å·¥ä½œæµå¯è§†åŒ–ã€‚
"""

import json
from typing import Optional, Literal
from pathlib import Path
from langgraph.graph.state import CompiledStateGraph

# å°è¯•å¯¼å…¥ MermaidDrawArgsï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨ç©ºå­—å…¸
try:
    from langgraph.graph import MermaidDrawArgs
except ImportError:
    # æ—§ç‰ˆæœ¬æˆ–ä¸åŒç‰ˆæœ¬çš„ LangGraph å¯èƒ½æ²¡æœ‰è¿™ä¸ªç±»
    MermaidDrawArgs = None


def get_graph_mermaid(
    workflow: CompiledStateGraph, title: str = "Workflow Graph", xray: bool = False
) -> str:
    """è·å–å·¥ä½œæµçš„ Mermaid æ ¼å¼å›¾è¡¨ã€‚

    è¯¥å‡½æ•°æå–ç¼–è¯‘åçš„å·¥ä½œæµå¹¶ç”Ÿæˆ Mermaid æ ¼å¼çš„å›¾è¡¨ä»£ç ï¼Œ
    å¯ç”¨äºæ–‡æ¡£ã€Markdown æ–‡ä»¶æˆ–æ”¯æŒ Mermaid çš„å¹³å°ã€‚

    Args:
        workflow: ç¼–è¯‘åçš„å·¥ä½œæµ (CompiledStateGraph)
        title: å›¾è¡¨æ ‡é¢˜ï¼Œç”¨äºæ·»åŠ æ³¨é‡Šå¤´éƒ¨
        xray: æ˜¯å¦å¯ç”¨ X å°„çº¿æ¨¡å¼ï¼ˆæ˜¾ç¤ºæ›´å¤šå†…éƒ¨ç»†èŠ‚ï¼‰

    Returns:
        Mermaid æ ¼å¼çš„å›¾è¡¨ä»£ç å­—ç¬¦ä¸²

    Example:
        >>> from src.agents.workflows.query import create_query_workflow
        >>> workflow = create_query_workflow(rag_adapter)
        >>> mermaid_code = get_graph_mermaid(workflow, "æŸ¥è¯¢å·¥ä½œæµ")
        >>> print(mermaid_code)
    """
    try:
        # è·å–å›¾å¯¹è±¡
        graph = workflow.get_graph()

        # ç”Ÿæˆ Mermaid ä»£ç 
        # å°è¯•ä½¿ç”¨ draw_mermaid æ–¹æ³•
        if hasattr(graph, "draw_mermaid"):
            if MermaidDrawArgs is not None:
                # æ–°ç‰ˆæœ¬ LangGraph
                mermaid_code = graph.draw_mermaid(MermaidDrawArgs(curve_style="linear"))
            else:
                # æ—§ç‰ˆæœ¬æˆ–ä¸æ”¯æŒå‚æ•°çš„ç‰ˆæœ¬
                mermaid_code = graph.draw_mermaid()
        elif hasattr(graph, "print_mermaid"):
            # ä½¿ç”¨ print_mermaid ä½œä¸ºå¤‡é€‰
            mermaid_code = graph.print_mermaid()
        else:
            # æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨ draw_mermaid_png çš„æ–‡æœ¬ç‰ˆæœ¬
            import io
            from contextlib import redirect_stdout

            f = io.StringIO()
            try:
                with redirect_stdout(f):
                    # å°è¯•ç›´æ¥æ‰“å°
                    print(graph)
                mermaid_code = f.getvalue()
            except Exception:
                mermaid_code = "%% Unable to generate Mermaid diagram from this graph"

        # æ·»åŠ æ ‡é¢˜æ³¨é‡Š
        if title and isinstance(mermaid_code, str):
            header = (
                f"%% {title}\n%% Generated by Medical-Graph-RAG Visualization Module\n"
            )
            mermaid_code = header + mermaid_code

        return mermaid_code

    except Exception as e:
        return f"%% Error generating Mermaid diagram: {str(e)}"


def save_graph_mermaid(
    workflow: CompiledStateGraph, output_path: str, title: str = "Workflow Graph"
) -> None:
    """ä¿å­˜å·¥ä½œæµå›¾ä¸º Mermaid æ–‡ä»¶ã€‚

    å°†å·¥ä½œæµçš„ Mermaid è¡¨ç¤ºä¿å­˜åˆ°æŒ‡å®šè·¯å¾„çš„æ–‡ä»¶ä¸­ã€‚
    æ–‡ä»¶æ‰©å±•åé€šå¸¸ä¸º .mmd æˆ– .mermaidã€‚

    Args:
        workflow: ç¼–è¯‘åçš„å·¥ä½œæµ
        output_path: è¾“å‡ºæ–‡ä»¶çš„å®Œæ•´è·¯å¾„
        title: å›¾è¡¨æ ‡é¢˜

    Raises:
        IOError: å¦‚æœæ–‡ä»¶å†™å…¥å¤±è´¥
        ValueError: å¦‚æœ workflow ä¸º None

    Example:
        >>> from src.agents.workflows.query import create_query_workflow
        >>> workflow = create_query_workflow(rag_adapter)
        >>> save_graph_mermaid(workflow, "query_workflow.mmd", "æŸ¥è¯¢å·¥ä½œæµ")
    """
    if workflow is None:
        raise ValueError("Workflow cannot be None")

    # ç”Ÿæˆ Mermaid ä»£ç 
    mermaid_code = get_graph_mermaid(workflow, title)

    # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
    output_file = Path(output_path)
    output_file.parent.mkdir(parents=True, exist_ok=True)

    # å†™å…¥æ–‡ä»¶
    with open(output_file, "w", encoding="utf-8") as f:
        f.write(mermaid_code)


def print_graph(
    workflow: CompiledStateGraph, title: str = "Workflow Graph", xray: bool = False
) -> None:
    """æ‰“å°å·¥ä½œæµç»“æ„åˆ°æ§åˆ¶å°ã€‚

    åœ¨ç»ˆç«¯ä¸­ä»¥ç¾è§‚çš„æ ¼å¼æ‰“å°å·¥ä½œæµçš„ Mermaid å›¾è¡¨ã€‚
    é€‚åˆå¿«é€ŸæŸ¥çœ‹å’Œè°ƒè¯•å·¥ä½œæµç»“æ„ã€‚

    Args:
        workflow: ç¼–è¯‘åçš„å·¥ä½œæµ
        title: å›¾è¡¨æ ‡é¢˜
        xray: æ˜¯å¦å¯ç”¨ X å°„çº¿æ¨¡å¼

    Example:
        >>> from src.agents.workflows.query import create_query_workflow
        >>> workflow = create_query_workflow(rag_adapter)
        >>> print_graph(workflow, "æŸ¥è¯¢å·¥ä½œæµ")
    """
    # ç”Ÿæˆ Mermaid ä»£ç 
    mermaid_code = get_graph_mermaid(workflow, title, xray)

    # æ‰“å°åˆ†éš”çº¿å’Œæ ‡é¢˜
    separator = "=" * 80
    print(f"\n{separator}")
    print(f"{title:^80}")
    print(f"{separator}\n")

    # æ‰“å° Mermaid ä»£ç 
    print(mermaid_code)

    # æ‰“å°ä½¿ç”¨æç¤º
    print(f"\n{separator}")
    print("ğŸ’¡ æç¤º: å¤åˆ¶ä¸Šè¿° Mermaid ä»£ç åˆ°æ”¯æŒ Mermaid çš„ç¼–è¾‘å™¨æŸ¥çœ‹å¯è§†åŒ–å›¾è¡¨")
    print("   æ¨èå·¥å…·: https://mermaid.live/, VS Code (Mermaid æ’ä»¶), Typora")
    print(f"{separator}\n")


def visualize_workflow(
    workflow: CompiledStateGraph,
    output_path: Optional[str] = None,
    format: Literal["mermaid", "ascii", "json"] = "mermaid",
    title: str = "Workflow Graph",
) -> str:
    """å¯è§†åŒ–å·¥ä½œæµï¼ˆé«˜çº§å‡½æ•°ï¼‰ã€‚

    æä¾›å¤šç§æ ¼å¼çš„å¯è§†åŒ–é€‰é¡¹ï¼Œå¹¶å¯é€‰æ‹©ä¿å­˜åˆ°æ–‡ä»¶æˆ–è¿”å›å­—ç¬¦ä¸²ã€‚

    Args:
        workflow: ç¼–è¯‘åçš„å·¥ä½œæµ
        output_path: è¾“å‡ºè·¯å¾„ï¼ˆå¯é€‰ï¼‰
        format: è¾“å‡ºæ ¼å¼
            - "mermaid": Mermaid å›¾è¡¨ä»£ç ï¼ˆé»˜è®¤ï¼‰
            - "ascii": ç®€åŒ–çš„ ASCII è‰ºæœ¯è¡¨ç¤º
            - "json": ç»“æ„åŒ–çš„ JSON æ ¼å¼
        title: å›¾è¡¨æ ‡é¢˜

    Returns:
        æ ¼å¼åŒ–åçš„å›¾è¡¨å­—ç¬¦ä¸²

    Raises:
        ValueError: å¦‚æœ format å‚æ•°æ— æ•ˆ

    Example:
        >>> from src.agents.workflows.query import create_query_workflow
        >>> workflow = create_query_workflow(rag_adapter)

        >>> # è·å– Mermaid æ ¼å¼
        >>> mermaid = visualize_workflow(workflow, format="mermaid")

        >>> # è·å– ASCII æ ¼å¼
        >>> ascii_art = visualize_workflow(workflow, format="ascii")

        >>> # ä¿å­˜åˆ°æ–‡ä»¶
        >>> visualize_workflow(workflow, "output.mmd", format="mermaid")
    """
    if workflow is None:
        raise ValueError("Workflow cannot be None")

    if format == "mermaid":
        result = get_graph_mermaid(workflow, title)
    elif format == "ascii":
        result = _generate_ascii_graph(workflow)
    elif format == "json":
        result = _generate_json_graph(workflow, title)
    else:
        raise ValueError(
            f"Invalid format '{format}'. Supported formats: 'mermaid', 'ascii', 'json'"
        )

    # å¦‚æœæŒ‡å®šäº†è¾“å‡ºè·¯å¾„ï¼Œä¿å­˜åˆ°æ–‡ä»¶
    if output_path:
        output_file = Path(output_path)
        output_file.parent.mkdir(parents=True, exist_ok=True)

        with open(output_file, "w", encoding="utf-8") as f:
            f.write(result)

    return result


def generate_html_viewer(
    workflow: CompiledStateGraph, output_path: str, title: str = "Workflow Graph"
) -> None:
    """ç”ŸæˆåŒ…å« Mermaid.js çš„ HTML å¯è§†åŒ–æ–‡ä»¶ã€‚

    åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ HTML æ–‡ä»¶ï¼Œå¯åœ¨æµè§ˆå™¨ä¸­ç›´æ¥æ‰“å¼€æŸ¥çœ‹å·¥ä½œæµå›¾ã€‚
    è¯¥æ–‡ä»¶åŒ…å« Mermaid.js åº“ï¼Œæ— éœ€é¢å¤–ä¾èµ–ã€‚

    Args:
        workflow: ç¼–è¯‘åçš„å·¥ä½œæµ
        output_path: è¾“å‡º HTML æ–‡ä»¶çš„è·¯å¾„
        title: å›¾è¡¨æ ‡é¢˜

    Example:
        >>> from src.agents.workflows.query import create_query_workflow
        >>> workflow = create_query_workflow(rag_adapter)
        >>> generate_html_viewer(workflow, "workflow.html", "æŸ¥è¯¢å·¥ä½œæµ")
        >>> # åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ workflow.html æŸ¥çœ‹å¯è§†åŒ–
    """
    mermaid_code = get_graph_mermaid(workflow, title)

    html_template = f"""<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title} - Workflow Visualization</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({{
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: {{
                curve: 'linear',
                padding: 20
            }}
        }});
    </script>
    <style>
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }}
        .container {{
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }}
        h1 {{
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }}
        .subtitle {{
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }}
        .mermaid {{
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }}
        .footer {{
            margin-top: 30px;
            text-align: center;
            color: #666;
            font-size: 12px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }}
    </style>
</head>
<body>
    <div class="container">
        <h1>{title}</h1>
        <p class="subtitle">LangGraph Workflow Visualization - Generated by Medical-Graph-RAG</p>
        <div class="mermaid">
{mermaid_code}
        </div>
        <div class="footer">
            <p>æç¤º: å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹æ­¤å›¾è¡¨ï¼Œæˆ–å¤åˆ¶ Mermaid ä»£ç åˆ°å…¶ä»–ç¼–è¾‘å™¨</p>
        </div>
    </div>
</body>
</html>"""

    output_file = Path(output_path)
    output_file.parent.mkdir(parents=True, exist_ok=True)

    with open(output_file, "w", encoding="utf-8") as f:
        f.write(html_template)


def generate_dot_format(
    workflow: CompiledStateGraph, output_path: str, title: str = "Workflow Graph"
) -> None:
    """å¯¼å‡º GraphViz DOT æ ¼å¼çš„å·¥ä½œæµå›¾ã€‚

    ç”Ÿæˆ GraphViz DOT æ ¼å¼çš„æ–‡ä»¶ï¼Œå¯ä½¿ç”¨ GraphViz å·¥å…·é›†
    æ¸²æŸ“ä¸ºé«˜è´¨é‡å›¾ç‰‡ï¼ˆPNG, SVG, PDF ç­‰ï¼‰ã€‚

    Args:
        workflow: ç¼–è¯‘åçš„å·¥ä½œæµ
        output_path: è¾“å‡º DOT æ–‡ä»¶çš„è·¯å¾„
        title: å›¾è¡¨æ ‡é¢˜

    Example:
        >>> from src.agents.workflows.query import create_query_workflow
        >>> workflow = create_query_workflow(rag_adapter)
        >>> generate_dot_format(workflow, "workflow.dot")
        >>> # ä½¿ç”¨ GraphViz æ¸²æŸ“: dot -Tpng workflow.dot -o workflow.png
    """
    mermaid_code = get_graph_mermaid(workflow, title)

    # è½¬æ¢ Mermaid åˆ° DOT æ ¼å¼ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
    dot_content = _mermaid_to_dot(mermaid_code, title)

    output_file = Path(output_path)
    output_file.parent.mkdir(parents=True, exist_ok=True)

    with open(output_file, "w", encoding="utf-8") as f:
        f.write(dot_content)


# ==================== è¾…åŠ©å‡½æ•° ====================


def _generate_ascii_graph(workflow: CompiledStateGraph) -> str:
    """ç”Ÿæˆç®€åŒ–çš„ ASCII è‰ºæœ¯è¡¨ç¤ºã€‚

    Args:
        workflow: ç¼–è¯‘åçš„å·¥ä½œæµ

    Returns:
        ASCII è‰ºæœ¯å­—ç¬¦ä¸²
    """
    try:
        graph = workflow.get_graph()

        # è·å–æ‰€æœ‰èŠ‚ç‚¹
        nodes = list(graph.nodes.keys())

        if not nodes:
            return "Empty workflow"

        # æ„å»º ASCII è¡¨ç¤º
        lines = []
        lines.append("â”Œâ”€ WORKFLOW STRUCTURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
        lines.append("â”‚")

        # æ˜¾ç¤ºèŠ‚ç‚¹
        for i, node in enumerate(nodes):
            connector = "â”œâ”€" if i < len(nodes) - 1 else "â””â”€"
            lines.append(f"â”‚ {connector} [{node}]")

            # å°è¯•è·å–èŠ‚ç‚¹çš„å‡ºè¾¹
            try:
                edges = list(graph.edges(node))
                for j, (_, target) in enumerate(edges):
                    edge_connector = "â”‚  â”œâ”€" if j < len(edges) - 1 else "â”‚  â””â”€"
                    lines.append(f"{edge_connector}â†’ {target}")
            except Exception:  # noqa: F841 - é™é»˜å¤„ç†å¼‚å¸¸ï¼Œç”¨äºå®¹é”™å±•ç¤º
                pass

        lines.append("â”‚")
        lines.append("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

        return "\n".join(lines)

    except Exception as e:
        return f"Error generating ASCII graph: {str(e)}"


def _generate_json_graph(workflow: CompiledStateGraph, title: str) -> str:
    """ç”Ÿæˆç»“æ„åŒ–çš„ JSON æ ¼å¼ã€‚

    Args:
        workflow: ç¼–è¯‘åçš„å·¥ä½œæµ
        title: å›¾è¡¨æ ‡é¢˜

    Returns:
        JSON æ ¼å¼å­—ç¬¦ä¸²
    """
    try:
        graph = workflow.get_graph()

        # æå–èŠ‚ç‚¹ä¿¡æ¯
        nodes_data = []
        for node_id, node in graph.nodes.items():
            nodes_data.append({"id": node_id, "type": str(type(node).__name__)})

        # æå–è¾¹ä¿¡æ¯
        edges_data = []
        try:
            for source, target in graph.edges:
                edges_data.append({"from": str(source), "to": str(target)})
        except Exception:  # noqa: F841 - é™é»˜å¤„ç†å¼‚å¸¸ï¼Œç”¨äºå®¹é”™å±•ç¤º
            pass

        # æ„å»º JSON ç»“æ„
        workflow_json = {
            "title": title,
            "type": "LangGraph Workflow",
            "nodes": nodes_data,
            "edges": edges_data,
            "node_count": len(nodes_data),
            "edge_count": len(edges_data),
        }

        return json.dumps(workflow_json, indent=2, ensure_ascii=False)

    except Exception as e:
        error_json = {"error": f"Error generating JSON graph: {str(e)}", "title": title}
        return json.dumps(error_json, indent=2, ensure_ascii=False)


def _mermaid_to_dot(mermaid_code: str, title: str) -> str:
    """å°† Mermaid ä»£ç è½¬æ¢ä¸º GraphViz DOT æ ¼å¼ã€‚

    è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„è½¬æ¢å‡½æ•°ï¼Œæä¾›åŸºæœ¬çš„ DOT æ ¼å¼æ”¯æŒã€‚

    Args:
        mermaid_code: Mermaid æ ¼å¼çš„ä»£ç 
        title: å›¾è¡¨æ ‡é¢˜

    Returns:
        DOT æ ¼å¼ä»£ç 
    """
    # ç®€åŒ–çš„è½¬æ¢é€»è¾‘
    lines = mermaid_code.split("\n")
    dot_lines = []

    dot_lines.append(f"// {title}")
    dot_lines.append("// Converted from Mermaid format")
    dot_lines.append("digraph workflow {")
    dot_lines.append("    rankdir=TD;")
    dot_lines.append("    node [shape=box, style=rounded];")
    dot_lines.append("")

    for line in lines:
        line = line.strip()
        if line.startswith("%%") or not line or line.startswith("graph TD;"):
            continue
        if line.startswith("classDef") or line.startswith("%%{init"):
            continue

        # è½¬æ¢èŠ‚ç‚¹å’Œè¾¹
        line = line.replace("-->", "->")
        line = line.replace("-.->", "-> [style=dashed]")
        line = line.replace("([", ' [shape=ellipse, label="')
        line = line.replace("])", '"]')

        if line and not line.startswith("%%"):
            dot_lines.append(f"    {line}")

    dot_lines.append("}")
    return "\n".join(dot_lines)


def compare_workflows(
    *workflows: CompiledStateGraph,
    titles: Optional[list[str]] = None,
    output_path: Optional[str] = None,
) -> str:
    """æ¯”è¾ƒå¤šä¸ªå·¥ä½œæµçš„ç»“æ„ã€‚

    ç”Ÿæˆå¹¶åˆ—æ˜¾ç¤ºå¤šä¸ªå·¥ä½œæµçš„ Mermaid å›¾è¡¨ï¼Œä¾¿äºæ¯”è¾ƒå·®å¼‚ã€‚

    Args:
        *workflows: å¤šä¸ªç¼–è¯‘åçš„å·¥ä½œæµ
        titles: å·¥ä½œæµæ ‡é¢˜åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
        output_path: è¾“å‡ºæ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰

    Returns:
        ç»„åˆçš„ Mermaid ä»£ç 

    Example:
        >>> query_workflow = create_query_workflow(rag_adapter)
        >>> build_workflow = create_build_workflow(rag_adapter)
        >>> compare = compare_workflows(
        ...     query_workflow, build_workflow,
        ...     titles=["æŸ¥è¯¢å·¥ä½œæµ", "æ„å»ºå·¥ä½œæµ"],
        ...     output_path="comparison.mmd"
        ... )
    """
    if not workflows:
        return "%% No workflows provided"

    if titles is None:
        titles = [f"Workflow {i + 1}" for i in range(len(workflows))]

    if len(titles) != len(workflows):
        raise ValueError("Number of titles must match number of workflows")

    # ä¸ºæ¯ä¸ªå·¥ä½œæµç”Ÿæˆå­å›¾
    subgraphs = []
    for i, (workflow, title) in enumerate(zip(workflows, titles)):
        mermaid = get_graph_mermaid(workflow, title)
        subgraph = f"    subgraph {title.replace(' ', '_')}\n{mermaid}\n    end"
        subgraphs.append(subgraph)

    # ç»„åˆæˆä¸€ä¸ª Mermaid å›¾è¡¨
    combined = "%% Workflow Comparison\n"
    combined += "%% Generated by Medical-Graph-RAG Visualization Module\n\n"
    combined += "graph TB\n"
    combined += "\n".join(subgraphs)

    if output_path:
        save_graph_mermaid(workflows[0], output_path, "Workflow Comparison")

    return combined
