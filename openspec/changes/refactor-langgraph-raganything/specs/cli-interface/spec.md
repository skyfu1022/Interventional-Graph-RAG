# CLI 接口规范

## 新增需求

### 需求：CLI 主应用

系统**必须**提供基于 Typer 的命令行接口。

#### 场景：显示帮助信息

**给定**：用户运行 `medgraph --help`

**那么**：应显示：
- 应用名称和描述
- 可用命令列表
- 全局选项说明

```
Medical Graph RAG - 医学知识图谱构建与检索系统

用法: medgraph [OPTIONS] COMMAND [ARGS]...

选项:
  --verbose          启用详细输出
  --config PATH      配置文件路径
  --help             显示帮助信息

命令:
  build    构建知识图谱
  query    执行查询
  ingest   摄入文档
  serve    启动 API 服务器
  export   导出图谱
```

#### 场景：显示命令帮助

**给定**：用户运行 `medgraph build --help`

**那么**：应显示该命令的详细帮助信息

---

### 需求：build 命令

系统**必须**提供用于构建知识图谱的 CLI 命令。

#### 场景：构建单个文件的图谱

**给定**：
- 一个医学文档文件 `report.pdf`

**当**：运行 `medgraph build report.pdf`

**那么**：
- 应显示构建进度（使用 Rich 进度条）
- 应显示提取的实体数量
- 应显示创建的关系数量
- 应返回生成的 `graph_id`

**输出示例**：
```
╭──────────────────────────────────────────────────────────╮
│           Medical Graph RAG - 构建知识图谱                │
╰──────────────────────────────────────────────────────────╯

⠋ 加载文档...................................... 1/1
⠙ 提取医学实体.................................... 127 个实体
⠹ 构建知识图谱.................................... 342 个关系
⠼ 创建摘要......................................... 完成

✅ 图谱构建完成！
   图谱ID: 550e8400-e29b-41d4-a716-446655440000
   实体数: 127
   关系数: 342
   用时: 2m 34s
```

#### 场景：构建目录中的所有文档

**给定**：
- 一个包含多个文档的目录

**当**：运行 `medgraph build ./data/mimic_ex`

**那么**：
- 应处理目录中的所有文档
- 应显示总体进度
- 应为每个文档创建子图

#### 场景：使用节点合并

**给定**：
- `--merge` 选项

**当**：运行 `medgraph build report.pdf --merge`

**那么**：
- 应在构建后执行节点合并
- 应显示合并的节点数量

#### 场景：启用三层关联

**给定**：
- `--trinity` 选项
- 已存在的图谱 ID

**当**：运行 `medgraph build report.pdf --trinity --trinity-gid1=graph-1 --trinity-gid2=graph-2`

**然后**：应创建跨图层的 REFERENCE 关系

---

### 需求：query 命令

系统**必须**提供用于执行查询的 CLI 命令。

#### 场景：交互式查询

**给定**：
- 用户运行 `medgraph query`

**当**：进入交互模式

**那么**：
- 应显示查询提示符
- 应接受用户输入
- 应显示格式化的答案
- 应显示来源引用

**交互示例**：
```
medgraph> 糖尿病患者的主要症状是什么？

📚 检索到 5 个相关文档

💡 答案：
糖尿病的主要症状包括多饮、多尿、多食和体重减轻。
这些症状通常称为"三多一少"。

📖 来源：
  [1] report.pdf (chunk 5) - 相关性: 0.95
  [2] textbook.pdf (chunk 12) - 相关性: 0.87
  ...

medgraph>
```

#### 场景：单次查询

**给定**：
- 用户运行 `medgraph query "糖尿病症状" --graph graph-123`

**那么**：
- 应直接执行查询
- 应显示结果
- 应退出

#### 场景：指定检索模式

**给定**：
- `--mode` 选项

**当**：运行 `medgraph query "..." --mode local`

**然后**：应使用指定的检索模式 (local/global/hybrid/naive)

---

### 需求：ingest 命令

系统**必须**提供用于摄入文档到知识库的 CLI 命令。

#### 场景：摄入单个文档

**给定**：
- 用户运行 `medgraph ingest paper.pdf`

**然后**：
- 应使用 RAG-Anything 处理文档
- 应显示摄入进度
- 应显示提取的多模态内容统计

**输出示例**：
```
⠋ 处理 paper.pdf
   📄 文本: 15,234 字符
   🖼️  图像: 3 个
   📊 表格: 2 个
   🧮 公式: 5 个

✅ 摄入完成！
   文档ID: doc-abc123
```

#### 场景：批量摄入

**给定**：
- 多个文件

**当**：运行 `medgraph ingest file1.pdf file2.pdf file3.pdf`

**然后**：应依次处理所有文件

---

### 需求：serve 命令

系统**必须**提供用于启动 API 服务器的 CLI 命令。

#### 场景：启动服务器

**给定**：
- 用户运行 `medgraph serve`

**当**：服务器启动

**然后**：
- 应显示服务器信息
- 应显示 API 文档地址
- 应保持运行直到用户中断

**输出示例**：
```
╭──────────────────────────────────────────────────────────╮
│              Medical Graph RAG API Server                 │
╰──────────────────────────────────────────────────────────╯

🚀 服务器启动成功！
   地址: http://0.0.0.0:8000
   API 文档: http://0.0.0.0:8000/docs

按 Ctrl+C 停止服务器
```

#### 场景：自定义主机和端口

**给定**：
- `--host` 和 `--port` 选项

**当**：运行 `medgraph serve --host 127.0.0.1 --port 9000`

**然后**：服务器应在指定地址和端口启动

#### 场景：启用热重载

**给定**：
- `--reload` 选项

**当**：运行 `medgraph serve --reload`

**然后**：代码更改应自动重新加载

---

### 需求：export 命令

系统**必须**提供用于导出图谱的 CLI 命令。

#### 场景：导出为 JSON

**给定**：
- `--format json` 选项

**当**：运行 `medgraph export graph-123 --format json --output output.json`

**然后**：图谱应被导出为 JSON 文件

#### 场景：导出为 Mermaid

**给定**：
- `--format mermaid` 选项

**当**：运行 `medgraph export graph-123 --format mermaid`

**然后**：应输出 Mermaid 图表代码

#### 场景：导出为 CSV

**给定**：
- `--format csv` 选项

**当**：运行 `medgraph export graph-123 --format csv --output nodes.csv --output-edges edges.csv`

**然后**：
- 节点应导出到 `nodes.csv`
- 边应导出到 `edges.csv`

---

### 需求：终端 UI

系统**必须**使用 Rich 提供美观的终端界面。

#### 场景：进度显示

**给定**：
- 长时间运行的操作

**当**：执行操作

**然后**：
- 应显示进度条
- 应显示当前步骤
- 应显示预估剩余时间

#### 场景：表格显示

**给定**：
- 需要显示列表数据

**当**：使用 Rich 表格

**然后**：
- 表格应有清晰的列标题
- 数据应正确对齐
- 长文本应被截断

**示例**：
```
┏━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━┓
┃ 图谱ID   ┃ 实体数  ┃ 关系数   ┃
┡━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━┩
│ graph-1  │ 127     │ 342      │
│ graph-2  │ 89      │ 156      │
└──────────┴─────────┴──────────┘
```

#### 场景：错误显示

**给定**：
- 发生错误

**当**：显示错误

**然后**：
- 应使用红色显示
- 应包含错误堆栈（如果 verbose）
- 应提供解决建议
