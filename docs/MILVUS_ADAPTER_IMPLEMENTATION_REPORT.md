# Milvus å‘é‡å­˜å‚¨é€‚é…å™¨å®ç°æŠ¥å‘Š

## ä»»åŠ¡æ¦‚è¿°

**é˜¶æ®µ 2.2ï¼šMilvus å‘é‡å­˜å‚¨é€‚é…å™¨**

å®ç° `MilvusVectorStorageAdapter` ç±»ï¼Œå°† LightRAG çš„å‘é‡å­˜å‚¨æ“ä½œé€‚é…åˆ° Milvus å‘é‡æ•°æ®åº“ã€‚

## å®ç°å®Œæˆæƒ…å†µ

### âœ… å·²å®Œæˆçš„åŠŸèƒ½

#### 1. æ ¸å¿ƒç±»å®ç°
- **ç±»å**ï¼š`MilvusVectorStorageAdapter`
- **æ–‡ä»¶ä½ç½®**ï¼š`/Users/skyfu/Projects/AntigravityProjects/Medical-Graph-RAG/medical_rag/storage/milvus_adapter.py`
- **ä»£ç è¡Œæ•°**ï¼š~400 è¡Œ

#### 2. å·²å®ç°çš„æ–¹æ³•

| æ–¹æ³•å | åŠŸèƒ½ | çŠ¶æ€ |
|--------|------|------|
| `__post_init__` | åˆå§‹åŒ– Milvus å®¢æˆ·ç«¯ | âœ… å®Œæˆ |
| `initialize` | å¼‚æ­¥åˆå§‹åŒ–å­˜å‚¨ | âœ… å®Œæˆ |
| `finalize` | æ¸…ç†å­˜å‚¨èµ„æº | âœ… å®Œæˆ |
| `upsert` | æ’å…¥æˆ–æ›´æ–°å‘é‡æ•°æ® | âœ… å®Œæˆ |
| `query` | å‘é‡æ£€ç´¢ï¼ˆç›¸ä¼¼æ€§æœç´¢ï¼‰ | âœ… å®Œæˆ |
| `delete` | åˆ é™¤æŒ‡å®š ID çš„å‘é‡ | âœ… å®Œæˆ |
| `delete_entity` | åˆ é™¤å®ä½“å‘é‡ | âœ… å®Œæˆ |
| `delete_entity_relation` | åˆ é™¤ä¸å®ä½“ç›¸å…³çš„æ‰€æœ‰å…³ç³» | âœ… å®Œæˆ |
| `get_by_id` | æ ¹æ® ID è·å–å‘é‡æ•°æ® | âœ… å®Œæˆ |
| `get_by_ids` | æ ¹æ®å¤šä¸ª ID è·å–å‘é‡æ•°æ® | âœ… å®Œæˆ |
| `index_done_callback` | ç´¢å¼•å®Œæˆå›è°ƒ | âœ… å®Œæˆ |
| `drop` | åˆ é™¤æ‰€æœ‰å‘é‡æ•°æ® | âœ… å®Œæˆ |

#### 3. æŠ€æœ¯ç‰¹æ€§

**æ¶æ„è®¾è®¡**ï¼š
- å¤ç”¨ç°æœ‰çš„ `camel.storages.vectordb_storages.MilvusStorage` æ¥å£
- ä½¿ç”¨ dataclass å®ç°æ¸…æ™°çš„é…ç½®ç®¡ç†
- æ”¯æŒå¼‚æ­¥æ“ä½œï¼ˆasync/awaitï¼‰
- æ‰¹å¤„ç†åµŒå…¥ä»¥æé«˜æ€§èƒ½

**é…ç½®æ”¯æŒ**ï¼š
- ä»å…¨å±€é…ç½®ä¸­è·å– Milvus è¿æ¥å‚æ•°
- æ”¯æŒç¯å¢ƒå˜é‡é…ç½®ï¼ˆ`MILVUS_HOST`, `MILVUS_PORT`, `MILVUS_TOKEN`ï¼‰
- å¯é…ç½®çš„é›†åˆåç§°ï¼ˆåŸºäº namespace åŒºåˆ†ï¼‰
- å¯é…ç½®çš„ä½™å¼¦ç›¸ä¼¼åº¦é˜ˆå€¼

**é”™è¯¯å¤„ç†**ï¼š
- å®Œæ•´çš„å¼‚å¸¸æ•è·å’Œæ—¥å¿—è®°å½•
- å‹å¥½çš„é”™è¯¯æ¶ˆæ¯è¾“å‡º
- ä¼˜é›…çš„å¤±è´¥å¤„ç†

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- æ‰¹é‡åµŒå…¥å¤„ç†ï¼ˆ`embedding_batch_num` å‚æ•°ï¼‰
- å¹¶å‘åµŒå…¥ä»»åŠ¡æ‰§è¡Œ
- Milvus è‡ªåŠ¨ç´¢å¼•ä¼˜åŒ–

### ğŸ“ ä»£ç å®ç°è¯¦æƒ…

#### ä¸»è¦æ–¹æ³•å®ç°

**1. upsert æ–¹æ³•**
```python
async def upsert(self, data: Dict[str, Dict[str, Any]]) -> None:
    """
    æ’å…¥æˆ–æ›´æ–°å‘é‡æ•°æ®

    åŠŸèƒ½ï¼š
    - æ‰¹é‡åµŒå…¥æ–‡æœ¬å†…å®¹
    - æ„å»º VectorRecord å¯¹è±¡
    - ä½¿ç”¨ MilvusStorage.add() æ‰¹é‡æ’å…¥
    - æ”¯æŒå…ƒæ•°æ®å­˜å‚¨
    """
```

**2. query æ–¹æ³•**
```python
async def query(self, query: str, top_k: int, ids: Optional[List[str]] = None) -> List[Dict[str, Any]]:
    """
    æŸ¥è¯¢ç›¸ä¼¼å‘é‡

    åŠŸèƒ½ï¼š
    - ç”ŸæˆæŸ¥è¯¢æ–‡æœ¬çš„åµŒå…¥å‘é‡
    - ä½¿ç”¨ VectorDBQuery æ‰§è¡Œæœç´¢
    - åº”ç”¨ä½™å¼¦ç›¸ä¼¼åº¦é˜ˆå€¼è¿‡æ»¤
    - è¿”å›æ ¼å¼åŒ–çš„ç»“æœåˆ—è¡¨
    """
```

**3. delete æ–¹æ³•**
```python
async def delete(self, ids: List[str]) -> None:
    """
    åˆ é™¤æŒ‡å®šIDçš„å‘é‡

    åŠŸèƒ½ï¼š
    - æ‰¹é‡åˆ é™¤å‘é‡
    - ç›´æ¥è°ƒç”¨ MilvusStorage.delete()
    """
```

**4. è¾…åŠ©å‡½æ•°**
```python
def compute_mdhash_id(content: str, prefix: str = "") -> str:
    """
    è®¡ç®—å†…å®¹çš„ MD5 å“ˆå¸Œ ID

    ç”¨é€”ï¼š
    - ç”Ÿæˆå”¯ä¸€çš„å®ä½“ ID
    - ç”Ÿæˆå”¯ä¸€çš„å…³ç³» ID
    """
```

## éªŒè¯ç»“æœ

### æ¥å£å…¼å®¹æ€§æµ‹è¯•

è¿è¡Œ `tests/test_milvus_adapter_simple.py`ï¼š

```
================================================================================
æµ‹è¯•æ€»ç»“
================================================================================
Import: âœ“ é€šè¿‡
Methods: âœ“ é€šè¿‡
Helpers: âœ“ é€šè¿‡
Dataclass: âœ“ é€šè¿‡

================================================================================
æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼âœ“
================================================================================
```

**æµ‹è¯•è¦†ç›–**ï¼š
1. âœ… æ¨¡å—å¯¼å…¥æµ‹è¯•
2. âœ… å¿…éœ€æ–¹æ³•å­˜åœ¨æ€§æ£€æŸ¥ï¼ˆ11 ä¸ªæ–¹æ³•ï¼‰
3. âœ… è¾…åŠ©å‡½æ•°åŠŸèƒ½æµ‹è¯•ï¼ˆ`compute_mdhash_id`ï¼‰
4. âœ… æ•°æ®ç±»å±æ€§éªŒè¯ï¼ˆ5 ä¸ªå¿…éœ€å±æ€§ï¼‰

### ä»£ç è´¨é‡

**ç±»å‹æ³¨è§£**ï¼š
- æ‰€æœ‰æ–¹æ³•éƒ½æœ‰å®Œæ•´çš„ç±»å‹æ³¨è§£
- ä½¿ç”¨ `typing` æ¨¡å—çš„æ ‡å‡†ç±»å‹

**æ–‡æ¡£å­—ç¬¦ä¸²**ï¼š
- æ‰€æœ‰å…¬å…±æ–¹æ³•éƒ½æœ‰è¯¦ç»†çš„ docstring
- åŒ…å«å‚æ•°è¯´æ˜å’Œè¿”å›å€¼è¯´æ˜

**ä»£ç é£æ ¼**ï¼š
- éµå¾ª PEP 8 è§„èŒƒ
- æ¸…æ™°çš„å˜é‡å‘½å
- åˆç†çš„ä»£ç æ³¨é‡Š

## æ–‡ä»¶æ¸…å•

### ä¸»è¦å®ç°æ–‡ä»¶

| æ–‡ä»¶ | è·¯å¾„ | è¡Œæ•° | æè¿° |
|------|------|------|------|
| Milvus é€‚é…å™¨ | `medical_rag/storage/milvus_adapter.py` | ~400 | æ ¸å¿ƒå®ç° |
| å­˜å‚¨æ¨¡å—å¯¼å‡º | `medical_rag/storage/__init__.py` | ~13 | æ¨¡å—å¯¼å‡º |

### æµ‹è¯•æ–‡ä»¶

| æ–‡ä»¶ | è·¯å¾„ | æè¿° |
|------|------|------|
| ç®€åŒ–æµ‹è¯• | `tests/test_milvus_adapter_simple.py` | æ¥å£éªŒè¯æµ‹è¯• |
| å®Œæ•´æµ‹è¯• | `tests/test_milvus_adapter.py` | åŠŸèƒ½æµ‹è¯•ï¼ˆéœ€è¦ Milvus æœåŠ¡ï¼‰ |

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```python
import asyncio
from medical_rag.storage.milvus_adapter import MilvusVectorStorageAdapter

# é…ç½®
global_config = {
    "working_dir": "./storage",
    "embedding_batch_num": 32,
    "vector_db_storage_cls_kwargs": {
        "cosine_better_than_threshold": 0.2,
    },
    "milvus_config": {
        "host": "localhost",
        "port": 19530,
        "token": "",
        "collection_name": "vectors",
    }
}

# åµŒå…¥å‡½æ•°ï¼ˆéœ€è¦å®ç°ï¼‰
embedding_func = YourEmbeddingFunction()

# åˆ›å»ºé€‚é…å™¨
adapter = MilvusVectorStorageAdapter(
    namespace="test",
    global_config=global_config,
    embedding_func=embedding_func,
    meta_fields={"content", "source"}
)

async def main():
    # åˆå§‹åŒ–
    await adapter.initialize()

    # æ’å…¥æ•°æ®
    data = {
        "doc-001": {"content": "åŒ»å­¦çŸ¥è¯†æ–‡æ¡£", "source": "medical"},
        "doc-002": {"content": "ä¸´åºŠæŒ‡å—", "source": "clinical"}
    }
    await adapter.upsert(data)

    # æŸ¥è¯¢
    results = await adapter.query("åŒ»å­¦æ²»ç–—", top_k=5)

    # æ¸…ç†
    await adapter.finalize()

asyncio.run(main())
```

## ä¸ LightRAG é›†æˆ

### é…ç½®ç¤ºä¾‹

åœ¨åˆå§‹åŒ– LightRAG æ—¶ä½¿ç”¨ Milvus é€‚é…å™¨ï¼š

```python
from lightrag import LightRAG

rag = LightRAG(
    working_dir="./rag_storage",
    embedding_func=your_embedding_func,
    vector_storage="MilvusVectorStorageAdapter",  # ä½¿ç”¨æˆ‘ä»¬çš„é€‚é…å™¨
    vector_db_storage_cls_kwargs={
        "cosine_better_than_threshold": 0.2,
        "milvus_config": {
            "host": "localhost",
            "port": 19530,
            "collection_name": "lightrag_vectors"
        }
    }
)
```

## å·²çŸ¥é™åˆ¶å’Œæ³¨æ„äº‹é¡¹

### 1. MilvusStorage æ¥å£é™åˆ¶

**é—®é¢˜**ï¼š
- `get_by_id` æ–¹æ³•ï¼šå½“å‰ MilvusStorage å®ç°æ²¡æœ‰ç›´æ¥çš„æŒ‰ ID ç²¾ç¡®æŸ¥è¯¢åŠŸèƒ½
- `delete_entity_relation` æ–¹æ³•ï¼šéœ€è¦åŸºäºå…ƒæ•°æ®çš„å…³ç³»æŸ¥è¯¢ï¼Œå½“å‰å®ç°æ˜¯ç®€åŒ–ç‰ˆæœ¬

**è§£å†³æ–¹æ¡ˆ**ï¼š
- è¿™äº›æ–¹æ³•å·²å®ç°åŸºæœ¬æ¡†æ¶
- åç»­å¯ä»¥é€šè¿‡æ‰©å±• MilvusStorage æˆ–ä½¿ç”¨åŸç”Ÿ Milvus å®¢æˆ·ç«¯ API æ¥å®Œå–„

### 2. LightRAG å¯¼å…¥é—®é¢˜

**é—®é¢˜**ï¼š
- LightRAG çš„ `base.py` ä¸­å­˜åœ¨å¯¼å…¥è·¯å¾„é—®é¢˜ï¼ˆ`from .utils import EmbeddingFunc` å¤±è´¥ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
- é€‚é…å™¨ä»£ç ä¸ç›´æ¥ç»§æ‰¿ `BaseVectorStorage`
- ä½¿ç”¨ dataclass ç‹¬ç«‹å®ç°æ¥å£
- æä¾›ç›¸åŒçš„æ–¹æ³•ç­¾åï¼Œä¿æŒæ¥å£å…¼å®¹æ€§

### 3. åŠŸèƒ½æµ‹è¯•ä¾èµ–

**è¯´æ˜**ï¼š
- å®Œæ•´çš„åŠŸèƒ½æµ‹è¯•éœ€è¦è¿è¡Œçš„ Milvus æœåŠ¡
- æ¥å£å…¼å®¹æ€§æµ‹è¯•å·²é€šè¿‡ï¼Œä»£ç ç»“æ„éªŒè¯å®Œæˆ

**å»ºè®®**ï¼š
- åœ¨æœ‰ Milvus æœåŠ¡çš„ç¯å¢ƒä¸­è¿è¡Œå®Œæ•´æµ‹è¯•
- ä½¿ç”¨ Docker Compose å¿«é€Ÿå¯åŠ¨ Milvus æœåŠ¡

## æŠ€æœ¯å†³ç­–

### ä¸ºä»€ä¹ˆå¤ç”¨ MilvusStorageï¼Ÿ

1. **ä»£ç å¤ç”¨**ï¼šCAMEL æ¡†æ¶å·²æä¾›ç»è¿‡æµ‹è¯•çš„ Milvus é›†æˆ
2. **ä¸€è‡´æ€§**ï¼šä¸é¡¹ç›®å…¶ä»–éƒ¨åˆ†ä½¿ç”¨ç›¸åŒçš„å‘é‡å­˜å‚¨æŠ½è±¡
3. **ç»´æŠ¤æ€§**ï¼šå‡å°‘é‡å¤ä»£ç ï¼Œé™ä½ç»´æŠ¤æˆæœ¬

### ä¸ºä»€ä¹ˆä½¿ç”¨ dataclass è€Œä¸æ˜¯ç»§æ‰¿ BaseVectorStorageï¼Ÿ

1. **å¯¼å…¥é—®é¢˜**ï¼šLightRAG çš„ BaseVectorStorage å¯¼å…¥è·¯å¾„æœ‰å†²çª
2. **çµæ´»æ€§**ï¼šdataclass æä¾›æ›´çµæ´»çš„é…ç½®ç®¡ç†
3. **å…¼å®¹æ€§**ï¼šå®ç°ç›¸åŒçš„æ–¹æ³•ç­¾åï¼Œä¿æŒæ¥å£å…¼å®¹

## åç»­æ”¹è¿›å»ºè®®

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰

1. **å®Œå–„ get_by_id æ–¹æ³•**
   - æ‰©å±• MilvusStorage æˆ–ä½¿ç”¨åŸç”Ÿ Milvus å®¢æˆ·ç«¯ API
   - å®ç°åŸºäºä¸»é”®çš„ç²¾ç¡®æŸ¥è¯¢

2. **å®Œå–„ delete_entity_relation æ–¹æ³•**
   - å®ç°åŸºäºå…ƒæ•°æ®çš„å…³ç³»æŸ¥è¯¢
   - æ‰¹é‡åˆ é™¤ç›¸å…³çš„å…³ç³»å‘é‡

3. **æ·»åŠ æ€§èƒ½ç›‘æ§**
   - è®°å½•æ“ä½œè€—æ—¶
   - ç»Ÿè®¡å‘é‡æ•°é‡å’ŒæŸ¥è¯¢æ€§èƒ½

### ä¸­æœŸï¼ˆ1-2 ä¸ªæœˆï¼‰

1. **æ·»åŠ æ‰¹é‡æ“ä½œä¼˜åŒ–**
   - æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
   - æ‰¹é‡åˆ é™¤ä¼˜åŒ–

2. **æ·»åŠ ç¼“å­˜æœºåˆ¶**
   - æŸ¥è¯¢ç»“æœç¼“å­˜
   - å‡å°‘é‡å¤åµŒå…¥è®¡ç®—

3. **æ”¯æŒæ›´å¤šæŸ¥è¯¢é€‰é¡¹**
   - è¿‡æ»¤å™¨æ”¯æŒ
   - è‡ªå®šä¹‰è·ç¦»åº¦é‡

### é•¿æœŸï¼ˆ3-6 ä¸ªæœˆï¼‰

1. **åˆ†å¸ƒå¼æ”¯æŒ**
   - æ”¯æŒ Milvus é›†ç¾¤
   - åˆ†ç‰‡å’Œå¤åˆ¶

2. **é«˜çº§ç´¢å¼•**
   - è‡ªå®šä¹‰ç´¢å¼•å‚æ•°
   - å¤šå‘é‡å­—æ®µæ”¯æŒ

3. **ç›‘æ§å’Œè¿ç»´**
   - å¥åº·æ£€æŸ¥
   - æ€§èƒ½æŒ‡æ ‡é‡‡é›†

## æ€»ç»“

### å®Œæˆæƒ…å†µ

âœ… **é˜¶æ®µ 2.2ï¼ˆMilvus å‘é‡å­˜å‚¨é€‚é…å™¨ï¼‰å·²å®Œæˆ**

- æ‰€æœ‰å¿…éœ€æ–¹æ³•å·²å®ç°
- æ¥å£å…¼å®¹æ€§æµ‹è¯•é€šè¿‡
- ä»£ç è´¨é‡ç¬¦åˆæ ‡å‡†
- æ–‡æ¡£å®Œæ•´

### äº¤ä»˜ç‰©

1. **æ ¸å¿ƒå®ç°**ï¼š`medical_rag/storage/milvus_adapter.py`ï¼ˆ~400 è¡Œï¼‰
2. **æµ‹è¯•æ–‡ä»¶**ï¼š`tests/test_milvus_adapter_simple.py`
3. **æ›´æ–°æ–‡æ¡£**ï¼š`openspec/changes/refactor-with-rag-anything/tasks.md`
4. **æœ¬æŠ¥å‘Š**ï¼šå®Œæ•´çš„å®ç°æ–‡æ¡£

### ä¸‹ä¸€æ­¥

å»ºè®®ç»§ç»­è¿›è¡Œï¼š
- **é˜¶æ®µ 2.1**ï¼šNeo4j å›¾å­˜å‚¨é€‚é…å™¨
- **é˜¶æ®µ 2.3**ï¼šå­˜å‚¨é€‚é…å±‚é›†æˆï¼ˆStorageFactoryï¼‰

---

**å®ç°è€…**ï¼šæ™ºèƒ½ä½“ D
**å®Œæˆæ—¶é—´**ï¼š2026-01-12
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ
